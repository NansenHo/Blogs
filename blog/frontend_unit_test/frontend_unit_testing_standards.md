# 単体テストに関する規範

> この規範は特定なプロジェクトにおいて作成したものなので、

## テスト環境

以下のコマンドで、Vitest をインストールします。

```bash
pnpm i vitest -D
# あるいは
yarn add vitest -D
# あるいは
npm i vitest -D
```

> Vitest が Develop 環境に使われるので、`-D` を必ずつけてインストールしてください。

## テストファイル

テストファイルはテスト対象モジュールと並列に `__tests__` ディレクトリに配置します。

```bash
store
  ├── __tests__
  │       └── count.spec.ts
  └── count.ts
```

## テストファイル

各テストファイルは一つのモジュールまたはコンポーネントのみをテストします。

テストファイルの命名は `*.spec.ts` をします。

例えば、`component.js` のテストファイルは `component.spec.js` とします。

## テストケース

各テストケースでは一つの概念のみをテストして、なるべく assert の数を少なくするようにしてください。

テストケースは説明的な**英語**で記述し、テストの目的を明確になるようにします。

例えば：

```js
it("should correctly calculate the sum of two numbers", () => {
  // テスト内容
});
```

> ❗ テストケースを作成する際に、`it` を統一して使用し、`test` を使用しないようにしましょう。

同一モジュールに対する異なるタイプのテスト（機能テスト、境界値テスト、エラー処理テスト、バグ修正テストなど）は、`describe` を使用して適切に分類する必要があります。

コード例：

```ts
describe("count", () => {
  it("should ...", () => {});

  describe("edge cases", () => {
    it("...", () => {});
  });

  describe("errors", () => {
    it("...", () => {});
  });

  describe("bugs", () => {
    it("...", () => {});
  });
});
```

単体テストの安定性と保守性を確保するために、テストケース間では相互に呼び出しを行うべきではなく、実行の順序に依存してもいけません。

悪い例：`testCase2` が `testCase1` の実行結果に依存し、その結果を `testCase2` の入力として使用する場合。

## テストケース

<!-- prettier-ignore -->
| Steps |  |  |
| --- | --- | --- |
| 1. **テスト用データを準備** | given | Arrange（準備） |
| 2. **テスト対象の機能/関数を呼び出す** | when | Act（実行） |
| 3. **機能の出力を検証** | then | Assert（検証） |
| 4. **ティアダウン** |||

> Arrange-Act-Assert (AAA) パターンに従う：準備（Arrange）、実行（Act）、アサート（Assert）。

第一歩と第四歩は必ずしも必要ではありませんが、第二歩と第三歩は必要です。

例えば、`getName()` をテストする時に、データの準備は必要ありません。

また、グローバルなデータに関わらない場合は、ティアダウンの必要がありません。

テスト中に、グローバルなデータやキャッシュを扱うことがあり、これらは元に戻す必要があります。これはティアダウンの役割です。

## テスト範囲

本プロジェクトでは、単体テストはシステムの最も核心的な機能とその周辺状況をカバーする必要があります。

もちろん、余力のある方はさらに多くの機能をカバーしていただいても構いません。

核心モジュールにテスト不可能なコードがある場合、適切なタイミングで必要なリファクタリングを行い、テスト可能なコードにするべきです。

> 核心モジュールのバグを修正する際には、そのバグを再現する単体テストケースまたはデモを用意する必要があります。

## Mocks と Stubs

外部サービスや状態などに依存する場合は、実際の実装に代わって `mock` や `stub` を使用してからテストを行う必要があります。

単体テストは、外部環境の影響を受けずに繰り返し実行可能であることを確保する必要があります。

`mock` や `stub` の具体的な実施方法については、フロントエンド単体テスト技術の共有資料を参照してください。

## テストコードをレビュー

テストコードもレビューされることを確保するように、@nansyou にレビューを投げてください。

## GitLab CI/CD

CI/CD プロセスに Vitest を統合して、各コミットまたはマージリクエストでテストを実行します。
