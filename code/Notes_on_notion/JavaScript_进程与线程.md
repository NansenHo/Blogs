# JavaScript 进程与线程

  - [一台电脑是怎么开机的？](#一台电脑是怎么开机的)
  - [操作系统怎么开启的 —— 以 Linux 为例](#操作系统怎么开启的--以-linux-为例)
- [JavaScript 进程与线程](#javascript-进程与线程)
  - [一台电脑是怎么开机的？](#一台电脑是怎么开机的)
  - [操作系统怎么开启的 —— 以 Linux 为例](#操作系统怎么开启的--以-linux-为例)
- [浏览器是怎么打开的](#浏览器是怎么打开的)
  - [浏览器的功能模块](#浏览器的功能模块)
  - [当我们输入一个网址到显示出来，浏览器做了啥](#当我们输入一个网址到显示出来浏览器做了啥)
- [进程与线程](#进程与线程)
  - [JavaScript 是单线程的](#javascript-是单线程的)
  - [JavaScript 怎么能去渲染页面呢](#javascript-怎么能去渲染页面呢)
    - [“DOM操作慢”](#dom操作慢)

> 一切都运行在内存里。

## 一台电脑是怎么开机的？

1. 在 Windows 系统，操作系统储存在 C 盘里；

   在 macOS，操作系统储存在根目录下的多个目录里。

2. 按下开机键让主板通电，开始读取固件（固件里有开机程序）；

> 🌳 固件：固定在主板上的存储设备，里面有写死的程序，为硬件服务。

3. 固件里的开机程序将硬盘里的操作系统加载到内存中运行。

## 操作系统怎么开启的 —— 以 Linux 为例

操作系统可以管理网络，自带文件管理系统，默认可以操作显示器，把最最基本的功能嵌入了其内核里面。

1. 首先加载操作系统内核；

2. 启动初始化进程，编号为 1（每个进程都有编号），

   Windows 可在任务管理器中进行查看；

3. 启动系统服务：文件、安全、联网等等；

4. 等待用户输入密码登录，或者用 ssh 来远程登陆；

5. 登陆后，运行桌面 / shell ，用户就可以开始使用了。Linux 的界面就是 shell；

   bash 是 shell 的一种，图形化界面也可以认为是一种 shell 。

# 浏览器是怎么打开的

1. 双击 chrome 图标（快捷方式），就会运行 chrome.exe 文件，就会开启一个 chrome 进程。

2. 这个 chrome 进程是一个**主进程**，它回去开启一些**辅助进程**（网络服务、CPU 加速等）。

> 🔥 浏览器是多进程的。
> 浏览器之所以能够运行，是因为系统给它的进程分配了资源（CPU、内存等）
> 简单来说，每打开一个 Tab 页，也就相当于创建了一个独立的浏览器进程。（并非绝对，可能浏览器内部有优化机制，会将这些进程合并成一个进程）

1. 我们每新建一个网页，都有可能开启一个**子进程**。

   但也不全都是这样的，有的时候相同域名会变成一个进程。

> 📌 进程可以在操作系统和 Chrome 的任务管理器里查看

## 浏览器的功能模块

- 提供一个用户界面

- **渲染引擎**

  把 HTML 和 CSS 渲染出来。

- **JS 引擎**

  解析并执行 JS 。

- 存储
 
- 等

上面这些功能模块一般都各处于不同的**线程**。

所以渲染引擎和 JS 引擎也都各自是一个线程。

> 🌱 **为什么 JS 有一个单独的引擎呢？**
> 因为 HTML 一开始就是自带样式的，后来不够用，才又有了 CSS 。所以他们两是不能分开的，分开的话展示的 HTML 就没有样式了。
> 而 JS 是后来另外发明的，所以才单独有一个引擎。

> 🔍 那既然 JS 引擎和渲染引擎是分开的，这岂不是说明 JS 是不可以进行渲染的？

> 🌿 引擎就是一些代码，运行引擎就是运行这些代码。

## 当我们输入一个网址到显示出来，浏览器做了啥

1. 发起请求

2. 下载 HTML（网络模块控制）

3. 读并理解/解析 HTML

4. 下载 CSS（网络模块控制）

5. 解析 CSS

6. 渲染界面

   渲染：把 HTML 和 CSS 解析并显示在屏幕上。

7. 下载 JS（网络模块控制）

8. 解析 JS

9. 执行 JS

10. 等等

> 📌 浏览器可以一边解析 HTML 一边下载 CSS ；但一般不可以一边下 HTML 一边解析 JS 。
> 如果在解析 HTML 的半道，下载了 JS 开始解析，那么就有可能会停掉 HTML ，先解析完 JS 之后才会回来解析 HTML 。
> 如， JS 往里面插节点等了，就不行，因为插东西进去后 HTML 就错了，只能等 JS 解析完了再回来解析它。
> 只要没有冲突，就可以同时进行，有冲突就不行

# 进程与线程

- 对于操作系统来说，一个任务就是一个**进程（process）**。

  比如打开 chrome 就是启动一个 chrome 进程，打开两个 keynote 就是启动了两个 keynote 进程。

- 而有些进程可以同时干很多件事。比如 keynote 可以同时打字，导出，画图形等。

  在一个进程内部，要同时干多件事，这些子任务就叫**线程（Thread）**。

进程和线程的关系可以理解为：进程是公司，线程是公司内部各小团队。

我们浏览器打开多个页面，打开的每一个页面都会开启一个渲染引擎线程和 JS 引擎线程。

- 进程：系统进行资源调度和分配的基本单位，实现了操作系统的并发。
- 线程：操作系统可识别的最小执行和调度单位。

## JavaScript 是单线程的

JavaScript 的单线程，与它的用途有关。作为浏览器脚本语言，JavaScript 的主要用途是与用户互动，以及操作 DOM。这决定了它只能是单线程，否则会带来很复杂的同步问题。

比如，假定 JavaScript 同时有两个线程，一个线程在某个 DOM 节点上添加内容，另一个线程删除了这个节点，这时浏览器应该以哪个线程为准？

所以，为了避免复杂性，从一诞生，JavaScript 就是单线程，这已经成了这门语言的核心特征，将来也不会改变。

为了利用多核 CPU 的计算能力，HTML5 提出 Web Worker 标准，允许 JavaScript 脚本创建多个线程，但是子线程完全受主线程控制，且不得操作 DOM。所以，这个新标准并没有改变 JavaScript 单线程的本质。

> 🌿 单线程和多线程的区别？
> 比如说，现在要计算 4 个数字式子。
> 单线程会一个一个算了给告诉你结果，一共要四步；
> 但多线程，比如 4 线程，会直接算出四个告诉你结果，一个线程算一个，一步搞定。

## JavaScript 怎么能去渲染页面呢

跨线程通信。

如果 JS 引擎需要去修改 HTML 或者 CSS ，它不能直接修改，要通过线程之间的通信，来通知渲染引擎。这个就叫做**跨线程通信**。

跨线程通信需要使用谷歌提供的功能，谷歌会提供跨线程通信的接口。

### “DOM操作慢”

跨线程通信要比线程内的代码要慢一点，所以就有一句话 “DOM 操作慢”。

DOM 操作就是跨线程的一个操作，因为是 JS 去操作渲染引擎。